# Docker Compose for Vixy Integration Tests
# This provides a simpler alternative to Kurtosis for local testing
#
# Usage:
#   cd docker && docker-compose up -d
#
# This sets up:
#   - 2 Geth nodes in dev mode (instant mining)
#   - Ports exposed for Vixy to connect
#
# Note: For full EL+CL testing, use Kurtosis instead

services:
  # Primary Geth node (dev mode)
  geth-primary:
    image: ethereum/client-go:latest
    container_name: vixy-geth-primary
    command:
      - --dev
      - --dev.period=1
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,debug,txpool
      - --http.corsdomain=*
      - --http.vhosts=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.api=eth,net,web3
      - --ws.origins=*
      - --verbosity=3
    ports:
      - "8545:8545"  # HTTP RPC
      - "8546:8546"  # WebSocket
    networks:
      - vixy-testnet
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Secondary Geth node (dev mode)
  geth-secondary:
    image: ethereum/client-go:latest
    container_name: vixy-geth-secondary
    command:
      - --dev
      - --dev.period=1
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,debug,txpool
      - --http.corsdomain=*
      - --http.vhosts=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.api=eth,net,web3
      - --ws.origins=*
      - --verbosity=3
    ports:
      - "8555:8545"  # HTTP RPC
      - "8556:8546"  # WebSocket
    networks:
      - vixy-testnet
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Mock CL node using a simple HTTP server
  # This simulates Beacon API responses for testing
  cl-mock-primary:
    image: nginx:alpine
    container_name: vixy-cl-mock-primary
    volumes:
      - ./cl-mock/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./cl-mock/responses:/usr/share/nginx/html:ro
    ports:
      - "5052:80"
    networks:
      - vixy-testnet
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:80/eth/v1/node/health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Secondary mock CL node
  cl-mock-secondary:
    image: nginx:alpine
    container_name: vixy-cl-mock-secondary
    volumes:
      - ./cl-mock/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./cl-mock/responses:/usr/share/nginx/html:ro
    ports:
      - "5053:80"
    networks:
      - vixy-testnet
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:80/eth/v1/node/health"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  vixy-testnet:
    driver: bridge
